---
title: "Deep Dive into xportr"
output: 
  rmarkdown::html_vignette:
    toc: true
    check_title: TRUE
vignette: >
  %\VignetteIndexEntry{deepdive}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = " "
)

library(DT)
```

# Introduction

This vignette will take you on a thorough journey of all the possibilities of the `xportr` package for applying specification attributes to multiple data sets through the `xportr` functions.  We will explore the following:

  * What goes in a Submission to a Health Authority?
  * What is `{xportr}` validating?
  * Breakdown of `{xportr}` and a ADaM dataset specification file
  * Using `{xportr}` `options()`
  * Understanding the warning and error messages for each `{xportr}` function
  * Using `{xportr}` to bulk process multiple datasets and Validation Software (?)
  * Future work

Before we begin, we encourage users to review the [Get Started Page](xportr.Rmd). This contains a simple walk through of applying `{xportr}` functions to an ADSL dataset given a specification file.  It is way less verbose!


# What goes in a Submission to a Health Authority?

## FDA

A Submission is a large package of information on a clinical trial.  

Version 5 xpts are the ADaM datasets that are submitted through the eTcd portal 

* What is `{xportr}` validating?

In `{xportr} v0.3.0` we give the users the ability to apply labels, formats, types, lengths to the R dataframe.  xportr also has the ability to order the dataset according to the specification file as well as write out the R dataframe as a version 5 xpt file, which is the preferred data standard to submit to health authoritries like the FDA.

Several of the xportr function have custom checks to validate.  

Example:  `xportr_label()` while applying labels form the specification will make sure that the label is <40 characters.


`xportr_write()` under the hood calls the `xpt_validate()` function, which does several more checks to make sure minimum complicance checks are being done.

* Name of dataframe must be 8 characters or less
* No non-ASCII, symbol or underscore characters
* Dataset label must be 40 characters or less and not have any non-ASCII, symbol or special characters.
* Variable Types must be "", "text", "integer", "float", "datetime", "date", "time",
    "partialdate", "partialtime", "partialdatetime",
    "incompletedatetime", "durationdatetime", "intervaldatetime"
*

## Materials used

* ADaM datasets from the Pilot 3 Submission to the FDA
* ADaM Specification Files from the Pilot 3 Submission to the FDA

## Set up our Environment

```{r, message=FALSE}

library(dplyr)
library(xportr)
```


## You got Options

As the Clinical Reporting landscape is so large we have found that a lot of companies have slight variations in how they construct their specification files.  For example, some companies will use Data Type or Type for their Column Names.  Something on character types.  

How can developers overcome this issue for an open-source package? The `xportr` package makes use of the `options()` function from base R to give your more control on naming conventions within in your specification file.

The `xportr` functions have been coded in a way that they expect all column names to all be in lower-case.  However, with `options()` you can override this assumption 

```{r}
options(xportr.variable_name = "Variable", 
        xportr.label = "Label",
        xportr.type_name = "Data Type",
        xportr.format = "Format")
```



## Load data 


## Load specification file

```{r}
spec_loc <- here::here("example_data_specs", "TDF_ADaM_Pilot3.xlsx")

var_spec <- readxl::read_xlsx(spec_loc, sheet = "Variables") %>% 
  filter(Variable != "TRTSDT" )
  
```


```{r}

var_spec_view <- var_spec %>% filter(Dataset == "ADSL")

DT::datatable(var_spec_view, options = list(
  autoWidth = FALSE, scrollX = TRUE, pageLength = 5,
  lengthMenu = c(5, 10, 15, 20)
))

```

## Contrived Examples for Error and Warning Messages


```{r}
adsl_loc <- here::here("example_data_specs", "adsl.xpt")

adsl <- haven::read_xpt(adsl_loc) %>% 
  metatools::remove_labels()

adsl_u <- xportr_label(adsl, var_spec, "ADSL", verbose = "warn")
```


## Warnings around label length
