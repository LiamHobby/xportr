---
title: "Deep Dive into xportr"
output: 
  rmarkdown::html_vignette:
    toc: true
    check_title: TRUE
vignette: >
  %\VignetteIndexEntry{deepdive}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = " "
)

library(DT)
```

# Introduction

This vignette will take explore in detail all the possibilities of the `{xportr}` package for applying information from a metadata object to multiple data sets using the core `{xportr}` functions. 

We will also explore the following:

  * What goes in a Submission to a Health Authority?
  * What is `{xportr}` validating behind the scenes?
  * Breakdown of `{xportr}` and a ADaM dataset specification file.
  * Understanding the warning and error messages for each `{xportr}` function.
  * Using `{xportr}` to bulk process multiple datasets.
  * Preparing xpt files for upload to a validation software.
  * Using `options()` to enhance your `{xportr}` experience.
  * Future work


**NOTE:** We use the phrase _metadata object_ through out this package.  A _metadata object_ can either be a specification file read into R as a dataframe or a `{metacore}` object. The __metadata object__ created in `{metacore}` has additional features not covered here, but at its core is using a specification file. However, the intention of `{xportr}` is for it to work with either a dataframe or a `{metacore}` object.

# What goes in a Submission to a Health Authority?

Quite a bit!  We will focus on the data deliverables needed for a successful submission to a Health Authority, which we can break down into three parts: 

1) Study Data Standardization Plan
2) SDTM Data Package
3) ADaM Data Package

## Study Data Standardization Plan

The Study Data Standardization Plan (SDSP) establishes and documents a plan for describing the data standardization approach for clinical and nonclinical studies within a development program. The SDSP also assists the FDA in identifying potential data standardization issues early in the development program. We hope the brevity of this section does not belie the huge importance of this document. Please see [Study Data Standardisation Plan (SDSP) Package](https://advance.phuse.global/display/WEL/Study+Data+Standardisation+Plan+%28SDSP%29+Package) maintained by the [PHUSE working group](https://advance.phuse.global/display/WEL/Welcome+to+the+PHUSE+Advance+Hub).  However, we want to focus more on the actual data and how `{xportr}` can play a role in the submission.

## SDTM Data Package

The primary pieces of the SDTM package are the SDTM annotated case report forms (acrf.pdf), the data definitions document (define.xml), the Study Data Reviewer's Guide (sdrg.pdf) and the datasets in xpt Version 5 format.  The Version 5 xpt file is the **required** submission format for all datasets going to the Health Authorities.  

In preparing the SDTM Data package, `{xportr}` can be used to apply information from the data specification files to the dataset. The `xportr_write()` can then be used to write out the final dataset as an `xpt` file that can be submitted to a Health Authority.

## ADaM Data Package

The key components of the ADaM package are very similar to SDTM package with a few additions: define.xml, Analysis Study Data Reviewer's Guide (adrg.pdf), Analysis Results Metadata (analysis-results-metadata.pdf) and datasets as Version 5 xpt format.

In preparing the ADaM Data package, `{xportr}` can be used to apply information from the data specification files to the dataset. The `xportr_write()` can then be used to write out the final dataset as an `xpt` file that can be submitted to a Health Authority.

## What is `{xportr}` validating in these Data Packages?

The `xpt` Version 5 files form the backbone of any successful Submission and are govern by quite a lot of rules and suggested guidelines. As you are preparing your packages for submission the suite of `{xportr}` functions and `xprotr_write()`, help to check that your datasets are submission compliant. The package checks many of the latest rules laid out in the [Study Data Technical Conformance Guide](https://www.fda.gov/regulatory-information/search-fda-guidance-documents/study-data-technical-conformance-guide-technical-specifications-document), but please note that it is not yet an exhaustive list of checks. We envision that users are also submitting their `xpts` to additional validation software.

In `{xportr} v0.3.0` we give the users the ability to apply labels, formats, types, lengths to the R dataframe. `{xportr}` also has the ability to order the dataset according to the specification file as well as write out the R dataframe as a `xpt` Version 5 file, which is the preferred data standard to submit to health authorities like the FDA.

We have developed the `{xportr}` functions to allow users flexibility to use errors and warnings to let them know of issues in their datasets or in their specification files. For example, let's say an accident deletion of the **TRTSDT** variable label occurred in the specification file. Using `xportr_label()` to apply all the labels would immediately alert the user that **TRTSDT**, while in the data, does not have an appropriate label available to applied to it.


```{r, message = FALSE, echo = FALSE}
library(dplyr)
library(xportr)

options(xportr.variable_name = "Variable", 
        xportr.label = "Label",
        xportr.type_name = "Data Type",
        xportr.format = "Format")

spec_loc <- here::here("example_data_specs", "TDF_ADaM_Pilot3.xlsx")

var_spec <- readxl::read_xlsx(spec_loc, sheet = "Variables") %>% 
  filter(Variable != "TRTSDT")

adsl_loc <- here::here("example_data_specs", "adsl.xpt")

adsl <- haven::read_xpt(adsl_loc) %>% 
  metatools::remove_labels() 
```


```{r}
adsl_lbl <- xportr_label(adsl, var_spec, "ADSL", verbose = "warn")
```

```{r}
library(dplyr)
library(xportr)

options(xportr.variable_name = "Variable", 
        xportr.label = "Label",
        xportr.type_name = "Data Type",
        xportr.format = "Format")

spec_loc <- here::here("example_data_specs", "TDF_ADaM_Pilot3.xlsx")

var_spec <- readxl::read_xlsx(spec_loc, sheet = "Variables") %>% 
  mutate(Label = if_else(Variable == "TRTSDT", 
                         "Date of First Exposure to Treatment Date of First Exposure to Treatment", Label))

adsl_loc <- here::here("example_data_specs", "adsl.xpt")

adsl <- haven::read_xpt(adsl_loc) %>% 
  metatools::remove_labels() 
```


```{r}
adsl_lbl <- xportr_label(adsl, var_spec, "ADSL", verbose = "warn")
```

Example:  `xportr_label()` while applying labels form the specification will make sure that the label is <40 characters.


`xportr_write()` under the hood calls the `xpt_validate()` function, which does several more checks to make sure minimum complicance checks are being done.

* Name of dataframe must be 8 characters or less
* No non-ASCII, symbol or underscore characters
* Dataset label must be 40 characters or less and not have any non-ASCII, symbol or special characters.
* Variable Types must be "", "text", "integer", "float", "datetime", "date", "time",
    "partialdate", "partialtime", "partialdatetime",
    "incompletedatetime", "durationdatetime", "intervaldatetime"
*

## Materials used

* ADaM datasets from the Pilot 3 Submission to the FDA
* ADaM Specification Files from the Pilot 3 Submission to the FDA

## Set up our Environment

```{r, message=FALSE}

library(dplyr)
library(xportr)
```


## You got Options

As the Clinical Reporting landscape is so large we have found that a lot of companies have slight variations in how they construct their specification files.  For example, some companies will use Data Type or Type for their Column Names.  Something on character types.  

How can developers overcome this issue for an open-source package? The `xportr` package makes use of the `options()` function from base R to give your more control on naming conventions within in your specification file.

The `xportr` functions have been coded in a way that they expect all column names to all be in lower-case.  However, with `options()` you can override this assumption 

```{r}
options(xportr.variable_name = "Variable", 
        xportr.label = "Label",
        xportr.type_name = "Data Type",
        xportr.format = "Format")
```



## Load data 


## Load specification file

```{r}
spec_loc <- here::here("example_data_specs", "TDF_ADaM_Pilot3.xlsx")

var_spec <- readxl::read_xlsx(spec_loc, sheet = "Variables") %>% 
  filter(Variable != "TRTSDT" )
  
```


```{r}

var_spec_view <- var_spec %>% filter(Dataset == "ADSL")

DT::datatable(var_spec_view, options = list(
  autoWidth = FALSE, scrollX = TRUE, pageLength = 5,
  lengthMenu = c(5, 10, 15, 20)
))

```

## Contrived Examples for Error and Warning Messages


```{r}
adsl_loc <- here::here("example_data_specs", "adsl.xpt")

adsl <- haven::read_xpt(adsl_loc) %>% 
  metatools::remove_labels()

adsl_u <- xportr_label(adsl, var_spec, "ADSL", verbose = "warn")
```


## Warnings around label length
